'use strict';

angular.module('mean').controller('UsersController', ['$scope', 'Global', 'Menus', '$rootScope', '$http', 'Users', '$filter',
    function($scope, Global, Menus, $rootScope, $http, Users, $filter) {
        $scope.global = Global;
        
        $scope.test = new Date();

        $scope.userSchema = [{
            title: 'Email',
            schemaKey: 'email',
            type: 'text',
            inTable: true,
            inForm : true
        }, {
            title: 'Name',
            schemaKey: 'name',
            type: 'text',
            inTable: true,
            inForm : true
        }, {
            title: 'Livres, BD, Magazines',
            schemaKey: 'livre_mag_revue',
            type: 'date',
            inTable: true,
            inForm : false
        }, {
            title: 'DVD',
            schemaKey: 'DVD',
            type: 'date',
            inTable: true,
            inForm : false
        }, {
            title: 'CD',
            schemaKey: 'CD',
            type: 'date',
            inTable: true,
            inForm : false
        }, {
            title: 'Caution',
            schemaKey: 'caution',
            type: 'date',
            inTable: true,
            inForm : false
        }, {
            title: 'Paiement',
            schemaKey: 'paiement',
            type: 'date',
            inTable: true,
            inForm : false
         }, {
            title: 'Password',
            schemaKey: 'password',
            type: 'password',
            inTable: false,
            inForm : true
        }, {
            title: 'Repeat password',
            schemaKey: 'confirmPassword',
            type: 'password',
            inTable: false,
            inForm : true
        }, {
            title: 'Roles',
            schemaKey: 'roles',
            type: 'select',
            options: ['authenticated', 'admin'],
            inTable: true,
            inForm : false
        }, {
            title: 'Username',
            schemaKey: 'username',
            type: 'text',
            inTable: true,
            inForm : true
        }];
        $scope.user = {};
        $scope.option_abo = [{'name' : 'BD, Livres, Magazines'},{'name' : 'Disque'}, {'name' : 'DVD'}];
        $scope.option_role = [ {'name' :'admin'}];
        // $scope.abo_select = {};
        // $scope.abo_select = {abos: []};

        $scope.selectedAbo = function () {
            $scope.abo_select = $filter('filter')($scope.option_abo, {checked: true});
        }

        $scope.selectedRole = function () {
            $scope.role_select = $filter('filter')($scope.option_role, {checked: true});
        }


        $scope.init = function() {
            Users.query({}, function(users) {
                $scope.users = users;
                $scope.users.forEach(function(user){
                    if(user.livre_mag_revue){
                        user.livre_mag_revue = new Date(user.livre_mag_revue).toISOString().substring(0, 10);
                    }
                    if(user.DVD){
                        user.DVD = new Date(user.DVD).toISOString().substring(0, 10);
                    }
                    if(user.CD){
                        user.CD = new Date(user.CD).toISOString().substring(0, 10);
                    }
                    if(user.caution){
                        user.caution = new Date(user.caution).toISOString().substring(0, 10);
                    }
                    if(user.paiement){
                        user.paiement = new Date(user.paiement).toISOString().substring(0, 10);
                    }
                });
            });
        };

        $scope.add = function() {
            if (!$scope.users) $scope.users = [];

            var user = new Users({
                email: $scope.user.email,
                name: $scope.user.name,
                username: $scope.user.username,
                password: $scope.user.password,
                confirmPassword: $scope.user.confirmPassword
                // roles: [],
                // abonnement : [{}]
            });
            user.abonnement = [];
            user.roles = [];
            var today = new Date();
            var end = new Date();
            end.setFullYear(today.getFullYear()+1);
            for(var i in $scope.abo_select){
                user.abonnement.push({
                    'nom' : $scope.abo_select[i].name,
                    'date_debut' : today,
                    'date_fin' : end
                });
            }
            user.roles.push('authenticated');
            for(var i in $scope.role_select){
                user.roles.push(
                   $scope.role_select[i].name
                );
            }
            // setTimeout(function(){
                console.log(user);
            // },5000);
            user.$save(function(response) {
                $scope.users.push(response);
            });

            this.firstName = this.lastName = this.email = this.password = this.role = '';
        };

        $scope.remove = function(user) {
            for (var i in $scope.users) {
                if ($scope.users[i] === user) {
                    $scope.users.splice(i, 1);
                }
            }

            user.$remove();
        };

        $scope.update = function(user, userField) {
            if (userField && userField === 'roles' && user.roles.indexOf('admin') === -1) {
                if (confirm('Are you sure you want to remove "admin" role?')) {
                    user.$update();
                } else {
                    user.roles = user.tmpRoles;
                }
            } else {
                user.$update(function(response){
                    if(user.livre_mag_revue){
                        user.livre_mag_revue = new Date(user.livre_mag_revue).toISOString().substring(0, 10);
                    }
                    if(user.DVD){
                        user.DVD = new Date(user.DVD).toISOString().substring(0, 10);
                    }
                    if(user.CD){
                        user.CD = new Date(user.CD).toISOString().substring(0, 10);
                    }
                    if(user.caution){
                        user.caution = new Date(user.caution).toISOString().substring(0, 10);
                    }
                    if(user.paiement){
                        user.paiement = new Date(user.paiement).toISOString().substring(0, 10);
                    }
                });
            }
        };

        $scope.beforeSelect = function(userField, user) {
            if (userField === 'roles') {
                user.tmpRoles = user.roles;
            }
        };

        $scope.validerNewAbo = function(user, newAbo, date_fin){
            console.log(user);
            if(newAbo === 'livre_mag_revue'){
                user.livre_mag_revue = date_fin;
            }else if(newAbo === 'DVD'){
                user.DVD = date_fin;
            }else if(newAbo === 'CD'){
                user.CD = date_fin;
            }else if(newAbo === 'caution'){
                user.caution = date_fin;
            }else if(newAbo === 'paiement'){
                user.paiement = date_fin;
            }
            // user.$update(function(response){
            //     message_info('Abonnement créé !');
            // });
        };

    }
]);